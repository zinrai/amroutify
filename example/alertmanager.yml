# Alertmanager Routing Configuration Example

route:
  # Default receiver
  receiver: 'slack-default'
  group_by:
    - 'alertname'
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h

  routes:
    # ============================================
    # 1. Maintenance mode - Discard alerts
    # ============================================
    - receiver: 'blackhole'
      match:
        maintenance: 'true'

    # ===========================================
    # 2. Batch job notifications - External system integration
    #    continue: true allows subsequent routes to be evaluated
    # ============================================
    - receiver: 'job-scheduler-webhook'
      repeat_interval: 720h
      match_re:
        batch_job_id: ".+"
      continue: true

    # ============================================
    # 3. Informational alerts - Dedicated channel
    # ============================================
    - receiver: 'slack-info'
      match:
        severity: 'info'

    # ============================================
    # 4. Debug alerts - Short repeat_interval
    #    Split by recovery status
    # ============================================
    - match:
        severity: 'debug'
      routes:
        - receiver: 'debug-with-resolve'
          repeat_interval: 5m
          match:
            recovery: 'true'
        - receiver: 'debug-fire-only'
          repeat_interval: 5m

    # ============================================
    # 5. Warning/Critical - Slack notifications
    #    continue: true allows subsequent detailed routes
    # ============================================
    - match_re:
        severity: '^(warning|critical)$'
      continue: true
      routes:
        - receiver: 'slack-with-resolve'
          repeat_interval: 6h
          match:
            recovery: 'true'
        - receiver: 'slack-alert'
          repeat_interval: 6h

    # ============================================
    # 6. Critical-only detailed routing
    #    Multiple notification methods combined
    # ============================================
    - match:
        severity: 'critical'
      routes:
        # 6-1. Phone escalation for specific team
        - receiver: 'oncall-phone'
          match:
            escalation_target: 'platform-team'
          group_interval: 2h
          repeat_interval: 2h
          group_by:
            - oncall_group

        # 6-2. Recovery notifications (email + alert lamp)
        - match:
            recovery: 'true'
          routes:
            - receiver: 'email-resolve'
              repeat_interval: 720h
              group_by: ['...']
              continue: true
            - receiver: 'alert-lamp-off'
              repeat_interval: 15m
              group_by: ['...']

        # 6-3. Firing notifications (email + alert lamp)
        - routes:
            - receiver: 'email-fire'
              repeat_interval: 720h
              group_by: ['...']
              continue: true
            - receiver: 'alert-lamp-on'
              repeat_interval: 15m
              group_by: ['...']

# ============================================
# Receivers
# ============================================
receivers:
  # Blackhole - discard alerts
  - name: 'blackhole'

  # Slack - informational notifications
  - name: 'slack-info'
    slack_configs:
      - api_url: "https://hooks.slack.com/services/AAAA/BBBB/CCCC"
        channel: "#alerts-info"
        color: '{{ template "slack.color" . }}'
        title: '{{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        actions:
          - type: button
            text: 'Query :mag:'
            url: '{{ template "__alert_generator_url" . }}'
          - type: button
            text: 'Silence :no_bell:'
            url: '{{ template "__alert_silence_link" . }}'

  # Slack - default alerts
  - name: 'slack-default'
    slack_configs:
      - api_url: "https://hooks.slack.com/services/AAAA/BBBB/CCCC"
        channel: "#alerts-general"
        color: '{{ template "slack.color" . }}'
        title: '{{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'

  - name: 'slack-alert'
    slack_configs:
      - api_url: "https://hooks.slack.com/services/AAAA/BBBB/CCCC"
        channel: "#alerts-critical"
        color: '{{ template "slack.color" . }}'
        title: '{{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'

  - name: 'slack-with-resolve'
    slack_configs:
      - api_url: "https://hooks.slack.com/services/AAAA/BBBB/CCCC"
        channel: "#alerts-critical"
        send_resolved: true
        color: '{{ template "slack.color" . }}'
        title: '{{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'

  # Webhook - alert lamp control
  - name: 'alert-lamp-on'
    webhook_configs:
      - url: 'http://localhost:8080/webhook/lamp'
        send_resolved: false

  - name: 'alert-lamp-off'
    webhook_configs:
      - url: 'http://localhost:8080/webhook/lamp'
        send_resolved: true

  # Webhook - email notifications
  - name: 'email-fire'
    webhook_configs:
      - url: 'http://localhost:8080/webhook/email'
        send_resolved: false

  - name: 'email-resolve'
    webhook_configs:
      - url: 'http://localhost:8080/webhook/email'
        send_resolved: true

  # Webhook - debug endpoint
  - name: 'debug-fire-only'
    webhook_configs:
      - url: 'http://localhost:8080/webhook/debug'
        send_resolved: false

  - name: 'debug-with-resolve'
    webhook_configs:
      - url: 'http://localhost:8080/webhook/debug'
        send_resolved: true

  # Webhook - job scheduler integration
  - name: 'job-scheduler-webhook'
    webhook_configs:
      - url: 'http://localhost:8080/webhook/scheduler'
        send_resolved: false

  # Webhook - phone escalation
  - name: 'oncall-phone'
    webhook_configs:
      - url: 'http://localhost:8080/webhook/oncall'
        send_resolved: false

# ============================================
# Templates
# ============================================
templates:
  - '/etc/alertmanager/templates/*.tmpl'
